name: Deploy SRE Agent

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true
    - name: Set up Python 3.10
      run: uv python install 3.10
    - name: Install dependencies
      run: uv sync --group dev
    - name: Run lint
      run: uv run poe lint
    - name: Run tests
      run: uv run poe test

  deploy:
    name: Deploy to Agent Engine
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v3
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v3

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python 3.10
      run: uv python install 3.10

    - name: Install dependencies
      run: uv sync

    - name: Deploy Agent
      env:
        GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
        GOOGLE_CLOUD_LOCATION: ${{ secrets.GOOGLE_CLOUD_LOCATION }}
        GOOGLE_CLOUD_STORAGE_BUCKET: ${{ secrets.GOOGLE_CLOUD_STORAGE_BUCKET }}
      run: |
        # Create empty .env to satisfy poe requirement
        touch .env
        uv run poe deploy
